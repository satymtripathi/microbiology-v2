{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}Process Request{% endblock %}

{% block content %}

<div class="mb-3">
  <h2 class="text-primary">
    <i class="fa-solid fa-microscope me-2"></i>{{ page_title }}
  </h2>
  <p class="text-muted">Review doctor details, inspect microscopy image, and complete report.</p>
</div>

{% if messages %}
  {% for m in messages %}
  <div class="alert alert-{{ m.tags }} alert-dismissible fade show">
    {{ m }} <button class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  {% endfor %}
{% endif %}

<div class="row g-3">

<!-- LEFT COLUMN -->
<div class="col-lg-7" style="max-height:88vh;overflow-y:auto;">

<div class="card shadow-sm border-0">
<div class="card-header bg-info text-white p-2">
<b>Request Details (Ref #{{ request_obj.id }})</b>
</div>
<div class="card-body small">

<table class="table table-sm table-borderless mb-0">
<tr><th>Patient ID</th><td>{{ request_obj.patient_id }}</td></tr>
<tr><th>Centre</th><td>{{ request_obj.centre_name }}</td></tr>
<tr><th>Sample</th><td>{{ request_obj.get_sample_display }}</td></tr>
<tr><th>Eye</th><td>{{ request_obj.get_eye_display }}</td></tr>
<tr><th>Duration</th><td>{{ request_obj.duration_value }} {{ request_obj.get_duration_unit_display }}</td></tr>
<tr><th>Impression</th><td>{{ request_obj.impression }}</td></tr>

<tr>
<th>Stains</th>
<td>
{% if stains %}
  {% for s in stains %}
    <span class="badge bg-primary me-1">{{ s }}</span>
  {% endfor %}
{% else %}
  <span class="badge bg-secondary">N/A</span>
{% endif %}
</td>
</tr>

<tr>
<th>Medications</th>
<td>
{% if request_obj.on_meds %}
  <span class="badge bg-warning text-dark">
    {% if request_obj.meds_category == "Others" %}
      {{ request_obj.meds_custom }}
    {% else %}
      {{ request_obj.get_meds_category_display }}
    {% endif %}
  </span>
{% else %}
  <span class="badge bg-secondary">None</span>
{% endif %}
</td>
</tr>

<tr><th>Submitted</th><td>{{ request_obj.timestamp|date:"M d, Y H:i" }}</td></tr>
</table>

</div>
</div>

<!-- IMAGE -->
<div class="card shadow-sm border-0 mt-3">
<div class="card-header bg-success text-white p-2"><b>Microscopy Image</b></div>
<div class="card-body text-center">

{% if request_obj.image %}
<img src="{{ request_obj.image.url }}"
     class="img-fluid rounded border"
     style="max-height:280px;cursor:zoom-in"
     data-bs-toggle="modal"
     data-bs-target="#imageModal">
<p class="small text-muted mt-2">Click to zoom</p>
{% else %}
<div class="alert alert-warning">No image uploaded.</div>
{% endif %}

</div>
</div>

</div>


<!-- RIGHT COLUMN -->
<div class="col-lg-5" style="position:sticky;top:90px;">

<div class="card shadow-sm border-0">
<div class="card-header bg-primary text-white p-2"><b>Lab Report</b></div>
<div class="card-body">

<form method="post" enctype="multipart/form-data" novalidate>
{% csrf_token %}
{{ form|crispy }}

<div class="alert alert-light border-start border-4 mt-3" style="border-color:#0dcaf0">
<i class="fa-solid fa-circle-check me-1"></i> Authorizing completes the case.
</div>

<div class="d-grid gap-2">
<button class="btn btn-success btn-lg">
Authorize & Complete
</button>

<a class="btn btn-outline-secondary" href="{% url 'lab_queue' %}">
Back
</a>
</div>

</form>

</div>
</div>

</div>

</div>


<!-- IMAGE MODAL -->
{% if request_obj.image %}
<div class="modal fade" id="imageModal">
  <div class="modal-dialog modal-xl modal-dialog-centered">
  <div class="modal-content">
  <div class="modal-header">
    <h5>Microscopy Image</h5>
    <button class="btn-close" data-bs-dismiss="modal"></button>
  </div>
  <div class="modal-body text-center">
    <img src="{{ request_obj.image.url }}" class="img-fluid">
  </div>
  </div>
  </div>
</div>
{% endif %}

{% endblock %}
